name: Sync from Google Drive

on:
  schedule:
    # 아침 (KST 7시, 8시, 9시)
    - cron: '0 22 * * *'   # KST 07:00
    - cron: '0 23 * * *'   # KST 08:00
    - cron: '0 0 * * *'    # KST 09:00
    # 오전 (KST 10시, 11시)
    - cron: '0 1 * * *'    # KST 10:00
    - cron: '0 2 * * *'    # KST 11:00
    # 점심 (KST 13시)
    - cron: '0 4 * * *'    # KST 13:00
    # 오후 (KST 15시, 17시)
    - cron: '0 6 * * *'    # KST 15:00
    - cron: '0 8 * * *'    # KST 17:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install google-api-python-client google-auth gspread

      - name: Run sync script
        id: sync
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          BRIEFINGS_SHEET_ID: '1OiLeRDrEb1lxXtL2CHGWkyfG0wA9r7QpEISw-3321n0'
        run: |
          python << 'EOF'
          import os
          import json
          import io
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload

          FOLDER_ID = os.environ['DRIVE_FOLDER_ID']
          SHEET_ID = os.environ['BRIEFINGS_SHEET_ID']
          SCOPES = [
              'https://www.googleapis.com/auth/drive.readonly',
              'https://www.googleapis.com/auth/spreadsheets.readonly'
          ]

          creds_json = os.environ['GOOGLE_SERVICE_ACCOUNT']
          creds_dict = json.loads(creds_json)
          creds = service_account.Credentials.from_service_account_info(creds_dict, scopes=SCOPES)
          
          drive_service = build('drive', 'v3', credentials=creds)
          sheets_service = build('sheets', 'v4', credentials=creds)

          def list_files(folder_id):
              results = drive_service.files().list(
                  q=f"'{folder_id}' in parents and trashed=false",
                  fields="files(id, name, mimeType, modifiedTime)"
              ).execute()
              return results.get('files', [])

          def download_file(file_id, file_name):
              request = drive_service.files().get_media(fileId=file_id)
              fh = io.BytesIO()
              downloader = MediaIoBaseDownload(fh, request)
              done = False
              while not done:
                  status, done = downloader.next_chunk()
              fh.seek(0)
              return fh.read()

          def sync_folder(folder_id, local_path='.'):
              files = list_files(folder_id)
              synced = []
              
              for file in files:
                  name = file['name']
                  file_id = file['id']
                  mime_type = file['mimeType']
                  
                  # Skip briefings.txt (now using Sheet instead)
                  if name == 'briefings.txt':
                      print(f"  Skipping {name} (using Sheet instead)")
                      continue
                  
                  if mime_type == 'application/vnd.google-apps.folder':
                      # Handle subfolders (like 'archive')
                      subfolder_path = os.path.join(local_path, name)
                      os.makedirs(subfolder_path, exist_ok=True)
                      synced.extend(sync_folder(file_id, subfolder_path))
                  else:
                      # Download file
                      file_path = os.path.join(local_path, name)
                      try:
                          content = download_file(file_id, name)
                          with open(file_path, 'wb') as f:
                              f.write(content)
                          print(f"  Downloaded: {file_path}")
                          synced.append(file_path)
                      except Exception as e:
                          print(f"  Error downloading {name}: {e}")
              
              return synced

          def sync_briefings_from_sheet():
              """Read briefings data from Google Sheet and generate briefings.json"""
              try:
                  # Read Sheet data - A:H (8 columns including highlights)
                  result = sheets_service.spreadsheets().values().get(
                      spreadsheetId=SHEET_ID,
                      range='A:H'
                  ).execute()
                  
                  rows = result.get('values', [])
                  if len(rows) < 2:
                      print("  No data in Sheet")
                      return False
                  
                  # Skip header row
                  header = rows[0]
                  data_rows = rows[1:]
                  
                  briefings = []
                  for row in data_rows:
                      # Ensure row has enough columns (pad if necessary)
                      while len(row) < 8:
                          row.append('')
                      
                      date, day, title, summary, articles, sections, picks, highlights = row[:8]
                      
                      # Skip empty rows
                      if not date or not title:
                          continue
                      
                      # Parse highlights (pipe-separated string → array)
                      highlights_list = []
                      if highlights:
                          highlights_list = [h.strip() for h in highlights.split('|') if h.strip()]
                      
                      briefing = {
                          "date": date,
                          "day": day,
                          "title": title,
                          "summary": summary,
                          "highlights": highlights_list,
                          "stats": {
                              "articles": int(articles) if articles else 0,
                              "sections": int(sections) if sections else 0,
                              "picks": int(picks) if picks else 0
                          }
                      }
                      briefings.append(briefing)
                  
                  # Write briefings.json
                  output = {"briefings": briefings}
                  with open('briefings.json', 'w', encoding='utf-8') as f:
                      json.dump(output, f, ensure_ascii=False, indent=2)
                  
                  print(f"  Generated briefings.json with {len(briefings)} entries")
                  return True
                  
              except Exception as e:
                  print(f"  Error reading Sheet: {e}")
                  return False

          # Main execution
          print(f"Syncing from Google Drive folder: {FOLDER_ID}")
          synced_files = sync_folder(FOLDER_ID)

          print(f"Syncing briefings from Sheet: {SHEET_ID}")
          sheet_synced = sync_briefings_from_sheet()

          if synced_files or sheet_synced:
              print(f"Synced {len(synced_files)} file(s) from Drive")
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write("synced=true\n")
          else:
              print("No files to sync")
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write("synced=false\n")
          EOF

      - name: Rename .txt to .html in archive folder
        if: steps.sync.outputs.synced == 'true'
        run: |
          if [ -d "archive" ]; then
            for f in archive/*.txt; do
              if [ -f "$f" ]; then
                newname="${f%.txt}.html"
                mv "$f" "$newname"
                echo "Renamed: $f -> $newname"
              fi
            done
          fi

      - name: Update Briefing List JSON
        if: steps.sync.outputs.synced == 'true'
        run: python scripts/generate_list.py

      - name: Build Search Index
        if: steps.sync.outputs.synced == 'true'
        run: python scripts/build_search_index.py

      - name: Commit and push changes
        if: steps.sync.outputs.synced == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Sync from Google Drive - $(date +'%Y-%m-%d %H:%M') UTC"
          git pull --rebase origin main
          git push
